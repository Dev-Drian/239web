$(document).ready(function () {
    $('#printTable').on('click', function () {
        const tableRows = $('#resultsBody tr');

        if (tableRows.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'No Data to Print',
                text: 'There are no results to print. Please update the data first.',
            });
            return;
        }

        // Preload logo image
        const img = new Image();
        img.src = logoUrl;

        img.onload = function () {
            const printWindow = window.open('', '_blank');
            const printDate = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            printWindow.document.write(`
    <html>
        <head>
            <title>Keyword Ranking Report</title>
            <style>
                @page { margin: 20px; }
                body { 
                    font-family: 'Arial', sans-serif; 
                    margin: 40px;
                }
                .header {
                    border-bottom: 2px solid #4C6A92;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .logo {
                    width: 200px;
                }
                .report-title {
                    color: #2c3e50;
                    font-size: 24px;
                    margin: 0;
                }
                .report-date {
                    color: #7f8c8d;
                    font-size: 14px;
                    text-align: right;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                th {
                    background-color: #4C6A92;
                    color: white;
                    padding: 15px;
                    text-align: left;
                    font-size: 14px;
                }
                td {
                    padding: 12px;
                    border-bottom: 1px solid #ecf0f1;
                    color: #2c3e50;
                }
                tr:nth-child(even) {
                    background-color: #f8f9fa;
                }
                .footer {
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid #bdc3c7;
                    text-align: center;
                    color: #7f8c8d;
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <img src="${logoUrl}" class="logo" alt="Company Logo">
                <div>
                    <h1 class="report-title">SEO Position Report</h1>
                    <p class="report-date">Generated: ${printDate}</p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        ${$('#resultsBody thead th').map((i, th) => `<th>${$(th).text()}</th>`).get().join('')}
                    </tr>
                </thead>
                <tbody>
                    ${$('#resultsBody tr').map((i, tr) => `
                                <tr>
                                    ${$(tr).find('td').map((j, td) => `<td>${$(td).text()}</td>`).get().join('')}
                                </tr>
                            `).get().join('')}
                </tbody>
            </table>
            <div class="footer">
                Confidential Report - Generated by SEO Analytics Tool
            </div>
        </body>
    </html>
`);

            // Delay printing to ensure content loads
            setTimeout(() => {
                printWindow.document.close();
                printWindow.print();
                printWindow.close();
            }, 500);
        };

        img.onerror = function () {
            Swal.fire({
                icon: 'error',
                title: 'Logo Error',
                text: 'Could not load company logo for printing',
            });
        };
    });
});
// Script para eliminar las filas "not found"
$(document).ready(function () {
    $('#removeNotFound').on('click', function () {
        $('tbody tr').each(function () {
            const position = $(this).find('.position').text().toLowerCase();
            if (position === 'not found' || position === '-') {
                $(this).remove();
            }
        });
    });
});

function exportToCsv() {
    const tableRows = $('#resultsBody tr');

    if (tableRows.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'No Results',
            text: 'There are no results to export.',
        });
        return;
    }

    // Crear el array de datos para Excel
    const data = [];
    
    // Añadir encabezados
    data.push(['Keyword', 'Position', 'Search Volume', 'CPC', 'URL', 'Difficulty']);

    // Añadir filas de datos
    tableRows.each(function () {
        const row = $(this);
        data.push([
            row.find('td:nth-child(1)').text(), // Keyword
            row.find('td:nth-child(2)').text(), // Position
            row.find('td:nth-child(3)').text(), // Search Volume
            row.find('td:nth-child(4)').text(), // CPC
            row.find('td:nth-child(5)').text(), // URL
            row.find('td:nth-child(6)').text()  // Difficulty
        ]);
    });

    // Crear libro de trabajo y hoja
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Añadir la hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, "Keyword Results");

    // Guardar el archivo
    XLSX.writeFile(wb, "keyword_results.xlsx");
}

// Event listener for the export button
$(document).ready(function () {
    $('#exportCsv').on('click', exportToCsv);
});